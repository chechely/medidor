"use strict";
var __spreadArrays = (this && this.__spreadArrays) || function () {
    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;
    for (var r = Array(s), k = 0, i = 0; i < il; i++)
        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)
            r[k] = a[j];
    return r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.flash = void 0;
var flash = function (options) {
    if (options === void 0) { options = { sessionKeyName: 'flash' }; }
    return function (req, response, next) {
        if (!req.session) {
            throw new Error('no session detected!');
        }
        var sessionKeyName = options.sessionKeyName, useCookieSession = options.useCookieSession;
        var keyName = sessionKeyName !== null && sessionKeyName !== void 0 ? sessionKeyName : 'flash';
        req.flash = function (event, message) {
            return new Promise(function (res, rej) {
                if (!req.session[keyName]) {
                    req.session[keyName] = {};
                }
                if (!req.session[keyName][event]) {
                    req.session[keyName][event] = [];
                }
                req.session[keyName][event].push(message);
                if (useCookieSession) {
                    res();
                    return;
                }
                req.session.save(function (err) {
                    if (err) {
                        return rej(err);
                    }
                    res();
                });
            });
        };
        req.consumeFlash = function (event) {
            return new Promise(function (res, rej) {
                var messages = [];
                if (req.session[keyName] && req.session[keyName][event]) {
                    messages = __spreadArrays(req.session[keyName][event]);
                    delete req.session[keyName][event];
                }
                if (useCookieSession) {
                    res(messages);
                    return;
                }
                req.session.save(function (err) {
                    if (err) {
                        return rej(err);
                    }
                    res(messages);
                });
            });
        };
        next();
    };
};
exports.flash = flash;
